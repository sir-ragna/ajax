<!DOCTYPE html>

<html>
<head>
    <title>get all users</title>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript" src="./js/DEBUG.js"></script>
    <script type="text/javascript" src="./js/server.js"></script>
</head>

<body>

<h1>Waiting for users</h1>

<div data-role="content">
    <div class="content-primary">
        <ul id="users" data-role="listview">
<!--           <li><li><h3>r@vdg.info</h3><p>Bekijk de pakketjes van de gebruiker: r@vdg.info</p><ul><li><div>10</div><p>Ophaal adres: Jabbeke<br>
Bestemmings adres: Brugge<br>
Beschrijving: Love letter<br>
Huidige Status: ON_WAY<br>
Type: envelope</p></li><li><div>11</div><p>Ophaal adres: Jabbeke<br>
Bestemmings adres: Brugge<br>
Beschrijving: Love letter<br>
Huidige Status: DELIVERED<br>
Type: envelope</p></li></ul></li><li><h3>i@dv.info</h3><p>Bekijk de pakketjes van de gebruiker: i@dv.info</p><ul><li><div>12</div><p>Ophaal adres: Brugge<br>
Bestemmings adres: Jabbeke<br>
Beschrijving: re:Invitation<br>
Huidige Status: TO_PICKUP<br>
Type: envelope</p></li><li><div>13</div><p>Ophaal adres: Brugge<br>
Bestemmings adres: Jabbeke<br>
Beschrijving: Stop stalking me<br>
Huidige Status: ON_WAY<br>
Type: envelope</p></li></ul></li>-->
        </ul>
    </div>
    <button id="btn-getusers" type="button">Get Users</button>
</div>
<script type="application/x-javascript">
    document.getElementById("btn-getusers").onclick = function(target){
        getAllUsers();
    };
    
    var buildList = function(users){
        var usersList = document.getElementById('users');
        usersList.innerHTML = "";
        for (email in users) {
            var li = document.createElement('li');
            var title = document.createElement('h3');
            var descr = document.createElement('p');
            descr.innerHTML = "Bekijk de pakketjes van de gebruiker: " + email;
            title.innerHTML = email;
            
            li.appendChild(title);
            li.appendChild(descr);
            
            var ulPackageList = document.createElement('ul');
            // pakket details
            for (packetIndex in users[email]) {
                var liPackage = document.createElement('li');
                var packet = users[email][packetIndex];
                var id = document.createElement('div');
                var extended_descr = document.createElement('p');
                extended_descr.innerHTML = [ "Ophaal adres: " + packet['start'],
                                   "Bestemmings adres: " + packet['stop'],
                                   "Beschrijving: " + packet['title'],
                                   "Huidige Status: " + packet['status'],
                                   "Type: " + packet['type']
                                  ].join('<br />\n');
                id.innerHTML = "" + packet['id'];
                liPackage.appendChild(id);
                liPackage.appendChild(extended_descr);
                ulPackageList.appendChild(liPackage);
            }
            
            li.appendChild(ulPackageList);

            usersList.appendChild(li);
        }
        $('#users').listview('refresh');
    };
    
    var getAllUsers = function(){
        var query = { action : "ALL" };
        
        server.sendJSON("json.php", query, callbackBoilerplate(function(response){
            // TODO handling of the response
            DEBUG("replied (^_^)");
            status = response['status'].toUpperCase();
            DEBUG(response);
            if ("SUCCES" === status) {
                buildList(response['users']);
            }
            
            
        }));
    
    };
       
    // TODO CRUD
    var updatePackage = function(){};
    
    /* callbackBoilerplate, gives back a function that check if the request
     * object actually contains a JSON response , calls the argument function
     * if so.
    */
    var callbackBoilerplate = function(func){
        
        var append_error_to_html = function(input, header_type){
            // We received the wrong header or could not parse the input JSON
            // Append possible error message to our body.
            console.log("Received header type: " + header_type);
            var div = document.createElement('div');
            div.classList.add("error");
            div.innerHTML = input;
            document.body.appendChild(div);
        }
        
        return (function(request){
            // Get headers and input
            var type = request.getResponseHeader("Content-Type").toLowerCase();
            var input = request.responseText;
            
            // print them for debugging purposes
            DEBUG("Content-Type: " + type);
            DEBUG("CONTENT: " + input);
         
            // do the headers give json?            
            if (type === "application/json") {
                try {
                    var json_reply = JSON.parse(input);
                    func(json_reply);
                } catch(e) {
                    DEBUG(e.message);
                    DEBUG("Not Actually JSON");
                    append_error_to_html(input, type);
                }                
            } else {
                DEBUG("Expected JSON header");
                append_error_to_html(input, type);
            }
        });
       
    };
    
</script>


</body>
</html>
